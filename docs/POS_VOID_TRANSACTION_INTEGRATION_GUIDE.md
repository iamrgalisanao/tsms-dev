# POS Void Transaction Integration Guide

## Overview
This guide provides POS developers with the technical specifications to integrate with the TSMS void transaction endpoint. The `voidFromPOS()` method allows authenticated POS terminals to void previously submitted transactions with proper security validation.

## Authentication Requirements

### Terminal Authentication
- **Method**: Sanctum Bearer Token Authentication
- **Header**: `Authorization: Bearer {terminal_token}`
- **Token Source**: Generated by TSMS TerminalTokenController
- **Security**: Each terminal can only void its own transactions

### Token Management
POS terminals can obtain Bearer tokens through:

1. **Administrative Dashboard** (Web UI)
   - Admin regenerates tokens via `/terminal-tokens/{id}/regenerate`
   - Token shown once for security

2. **API Endpoint** (Programmatic)
   ```http
   POST /api/v1/terminals/{terminalId}/generate-token
   Authorization: Bearer {admin_token}
   ```

3. **Legacy Authentication** (if enabled)
   ```http
   POST /api/v1/auth/terminal
   {
     "serial_number": "T12345",
     "api_key": "stored_api_key"
   }
   ```

## API Endpoint

```
POST /api/v1/transactions/{transaction_id}/void-pos
```

### Route Parameters
- `{transaction_id}` - The UUID of the transaction to void (must match request body)

## Request Specification

### Headers
```http
Content-Type: application/json
Authorization: Bearer {your_terminal_token}
```

### Request Body Format
```json
{
    "transaction_id": "550e8400-e29b-41d4-a716-446655440000",
    "void_reason": "Customer requested cancellation",
    "payload_checksum": "a1b2c3d4e5f6789012345678901234567890123456789012345678901234567890"
}
```

### Field Validation Rules
| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| `transaction_id` | string | ✅ | UUID, max 191 chars, must match route parameter | Transaction identifier |
| `void_reason` | string | ✅ | max 255 characters | Human-readable reason for voiding |
| `payload_checksum` | string | ✅ | exactly 64 characters (SHA-256 hash) | Security checksum of payload |

## Checksum Calculation

### Critical Security Requirement
The `payload_checksum` must be calculated using **SHA-256** with **canonicalized JSON**:

### Step 1: Create Payload Object
```javascript
// Only include these two fields - DO NOT include voided_at or timestamp
const payload = {
    "transaction_id": "550e8400-e29b-41d4-a716-446655440000",
    "void_reason": "Customer requested cancellation"
};
```

### Step 2: Canonicalize the Payload
```javascript
// Sort object keys alphabetically (critical for checksum validation)
function canonicalize(obj) {
    if (typeof obj !== 'object' || obj === null) return obj;
    
    if (Array.isArray(obj)) {
        return obj.map(canonicalize);
    }
    
    const sorted = {};
    Object.keys(obj).sort().forEach(key => {
        sorted[key] = canonicalize(obj[key]);
    });
    
    return sorted;
}

const canonicalPayload = canonicalize(payload);
```

### Step 3: Generate Checksum
```javascript
// Convert to JSON with specific flags
const jsonString = JSON.stringify(canonicalPayload, null, 0); // No spaces
const checksum = sha256(jsonString); // 64-character hex string
```

### Implementation Examples

#### JavaScript/Node.js
```javascript
const crypto = require('crypto');

function generateVoidChecksum(transactionId, voidReason) {
    const payload = {
        "transaction_id": transactionId,
        "void_reason": voidReason
    };
    
    // Canonicalize (sort keys)
    const canonical = {
        "transaction_id": payload.transaction_id,
        "void_reason": payload.void_reason
    };
    
    const jsonString = JSON.stringify(canonical);
    return crypto.createHash('sha256').update(jsonString).digest('hex');
}

// Usage
const checksum = generateVoidChecksum(
    "550e8400-e29b-41d4-a716-446655440000",
    "Customer requested cancellation"
);
```

#### Python
```python
import json
import hashlib

def generate_void_checksum(transaction_id, void_reason):
    payload = {
        "transaction_id": transaction_id,
        "void_reason": void_reason
    }
    
    # Ensure consistent key ordering
    canonical_payload = {
        "transaction_id": payload["transaction_id"],
        "void_reason": payload["void_reason"]
    }
    
    json_string = json.dumps(canonical_payload, separators=(',', ':'), sort_keys=True)
    return hashlib.sha256(json_string.encode('utf-8')).hexdigest()

# Usage
checksum = generate_void_checksum(
    "550e8400-e29b-41d4-a716-446655440000",
    "Customer requested cancellation"
)
```

#### C# / .NET
```csharp
using System;
using System.Security.Cryptography;
using System.Text;
using System.Text.Json;

public string GenerateVoidChecksum(string transactionId, string voidReason)
{
    var payload = new
    {
        transaction_id = transactionId,
        void_reason = voidReason
    };
    
    var jsonOptions = new JsonSerializerOptions 
    { 
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        WriteIndented = false
    };
    
    string jsonString = JsonSerializer.Serialize(payload, jsonOptions);
    
    using (SHA256 sha256Hash = SHA256.Create())
    {
        byte[] bytes = sha256Hash.ComputeHash(Encoding.UTF8.GetBytes(jsonString));
        return Convert.ToHexString(bytes).ToLower();
    }
}
```

## Response Handling

### Success Response (200 OK)
```json
{
    "success": true,
    "message": "Transaction voided successfully by POS",
    "transaction_id": "550e8400-e29b-41d4-a716-446655440000",
    "voided_at": "2025-08-12T14:30:00Z",
    "void_reason": "Customer requested cancellation"
}
```

### Error Responses

#### Validation Error (422)
```json
{
    "success": false,
    "message": "Validation failed",
    "errors": {
        "payload_checksum": ["Checksum validation failed"]
    }
}
```

#### Transaction ID Mismatch (422)
```json
{
    "success": false,
    "message": "Transaction ID mismatch",
    "errors": {
        "transaction_id": ["Request transaction_id must match the transaction being voided"]
    }
}
```

#### Unauthorized (401)
```json
{
    "success": false,
    "message": "Unauthorized - invalid terminal token"
}
```

#### Transaction Not Found (404)
```json
{
    "success": false,
    "message": "Transaction not found or does not belong to this terminal"
}
```

#### Already Voided (409)
```json
{
    "success": false,
    "message": "Transaction already voided",
    "voided_at": "2025-08-12T10:15:30Z",
    "void_reason": "Previous void reason"
}
```

## Business Rules & Constraints

### Transaction Ownership
- ✅ POS terminals can only void their own transactions
- ❌ Cannot void transactions from other terminals
- ❌ Cannot void transactions not associated with authenticated terminal

### Transaction State Validation
- ✅ Transaction must exist in the system
- ❌ Cannot void already voided transactions
- ❌ Cannot void transactions currently being processed (`validation_status = 'PROCESSING'`)

### Security Requirements
- ✅ Must provide valid terminal authentication token
- ✅ Request `transaction_id` must match route parameter
- ✅ Payload checksum must be valid SHA-256 hash
- ✅ All requests are logged for audit compliance

## Integration Checklist

### Pre-Implementation
- [ ] Obtain valid POS terminal API token from TSMS admin
- [ ] Implement SHA-256 checksum generation with canonicalization
- [ ] Set up proper error handling for all response codes
- [ ] Test checksum calculation against known values

### Implementation
- [ ] Implement proper JSON canonicalization (key sorting)
- [ ] Add request timeout handling (recommended: 30 seconds)
- [ ] Implement retry logic for network failures (not for business logic errors)
- [ ] Add comprehensive logging for debugging

### Testing
- [ ] Test with valid transaction void requests
- [ ] Test checksum validation with intentionally wrong checksums
- [ ] Test transaction ID mismatch scenarios
- [ ] Test attempting to void non-existent transactions
- [ ] Test attempting to void already voided transactions
- [ ] Test unauthorized access attempts

### Production Considerations
- [ ] Store terminal token securely (environment variables/secure config)
- [ ] Implement audit logging of void operations
- [ ] Handle network timeouts gracefully
- [ ] Provide user feedback for all error scenarios

## Common Integration Issues

### Checksum Failures
**Problem**: `payload_checksum` validation fails
**Causes**:
- Key ordering not alphabetical
- Including extra fields (`voided_at`, timestamps)
- Wrong JSON formatting (spaces, indentation)
- Using MD5 instead of SHA-256

**Solution**: Follow exact canonicalization steps above

### Authentication Issues
**Problem**: 401 Unauthorized responses
**Causes**:
- Invalid or expired terminal token
- Missing `Authorization` header
- Wrong header format

**Solution**: Verify token with TSMS admin, ensure proper Bearer format

### Business Logic Errors
**Problem**: 409 or 422 responses
**Causes**:
- Attempting to void already voided transactions
- Transaction doesn't belong to terminal
- Transaction ID mismatch between route and body

**Solution**: Implement proper pre-validation checks

## Support & Troubleshooting

### Debug Information
When experiencing issues, collect:
- Request payload (without sensitive tokens)
- Response body and status code
- Calculated checksum value
- Terminal ID and transaction ID

### Checksum Verification Tool
```bash
# Command line checksum verification (Linux/Mac)
echo -n '{"transaction_id":"550e8400-e29b-41d4-a716-446655440000","void_reason":"Customer requested cancellation"}' | sha256sum
```

### Contact Information
- Technical Support: [Your support channel]
- Documentation Updates: [Your documentation repo]
- API Status: [Your status page]

---
**Document Version**: 1.0  
**Last Updated**: August 12, 2025  
**API Version**: v1
