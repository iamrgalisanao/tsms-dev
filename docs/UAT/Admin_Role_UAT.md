# TSMS — Admin Role UAT

Version: 1.0
Date: 2025-09-23
Owner: Product / QA

Purpose
-------
This User Acceptance Test (UAT) defines the scenarios that must be verified by QA and product for the Admin role in the TSMS application. It covers authentication/authorization, operational dashboards (Horizon / command-center), key workflows (transaction ingestion, non-VAT handling, forwarding), auditability, queue resilience, and security checks.

Scope
-----
- Areas: Admin web UI, Horizon access (command-center), API-level administrative endpoints, queue/worker behaviour relevant to admin ops, audit logs and reports.
- Not in scope: developer-only CLI internals, vendor-managed infra unrelated to TSMS app (e.g., external DB admin tasks).

Prerequisites
-------------
- Staging environment deployed with the latest build of `main` and configuration variables set per `env.example`.
- A test Admin account exists (username: `admin@tsms.test`, role: `admin`) with a secure password supplied to test team.
- Redis and Horizon are running in staging; `php artisan horizon:status` returns active supervisors.
- Sample tenant/terminal test data seeded (tenant_id: `125`, terminal_id: `1`).
- Postman collection or test harness available with API authentication tokens for admin user.

Test Data
---------
- Admin user: admin@tsms.test / (provided password)
- Tenant: 125
- Terminal: 1
- Example submission_uuid(s): auto-generated by test harness
- Transaction sample: use `scripts/test_4986_payload.php` to generate valid payloads; include both VAT and non-VAT tax types.

Test Execution Notes
--------------------
- Execute tests in the order listed. Mark each step PASS/FAIL and attach evidence (screenshots, log snippets, job IDs).
- For any FAIL, capture logs from `storage/logs/laravel.log`, Horizon UI, and `php artisan queue:failed` output.

UAT Test Cases
--------------

TC-ADMIN-001 — Admin can sign in and access the command-center (Horizon)
- Purpose: Verify Admin authentication and authorization for the Horizon dashboard.
- Preconditions: Admin account exists and Horizon UI is reachable at `/command-center`.
- Steps:
  1. Open web app and sign in as Admin.
  2. Navigate to `/command-center` (Horizon route).
  3. Verify the Horizon UI loads and shows supervisors.
- Expected result: Admin can view Horizon; `can:viewHorizon` gate allows access. No 403/redirect.
- Evidence: Screenshot of Horizon UI showing supervisors and queue metrics.

TC-ADMIN-002 — Admin can view and search job queues and failed jobs
- Purpose: Ensure Admin can inspect job lists, failed jobs, and job details.
- Steps:
  1. From Horizon, open the 'Failed' section.
  2. Search for known job tags (e.g., `transaction:pk`) or use filters by queue `transaction-processing`.
  3. Click a failed job and inspect payload and exception trace.
- Expected result: Admin can view job payloads and stack traces. No sensitive PII should be shown in cleartext (verify redaction if applicable).

TC-ADMIN-003 — Admin can trigger a requeue / retry of a failed job (if allowed)
- Purpose: Verify the Admin can attempt to retry a failed job through the UI where policy permits.
- Steps:
  1. Identify a failed job in Horizon (or create a transient failure by temporarily causing a downstream error and re-running ingestion).
  2. Use the Horizon UI 'Retry' action on that job.
  3. Monitor the `transaction-processing` queue and worker log to ensure a retry was attempted.
- Expected result: Job is requeued and either succeeds or fails again. Admin action is logged in application audit trail.

TC-ADMIN-004 — Admin can view audit logs and transaction records for sample submission
- Purpose: Validate that admin UI provides access to transaction audit trails and that non-VAT sales are recorded/flagged.
- Steps:
  1. Submit a transaction payload with non-VAT tax types (use `scripts/test_4986_payload.php` or API).
  2. Wait for ingestion and processing to complete (observe Horizon job completion).
  3. In Admin UI, navigate to Transactions / Audit and find the submission by `submission_uuid` or `transaction_id`.
  4. Inspect transaction fields: taxes array, vat_exempt_sales, tax_exempt flag, transaction_timestamp.
- Expected result: Transaction record stored; `vat_exempt_sales` > 0 when non-VAT taxes present; `tax_exempt` flag true; transaction_timestamp preserved and visible. Capture DB row id and screenshot.

TC-ADMIN-005 — Admin can initiate a manual forward / resend to WebApp
- Purpose: Verify admin can trigger forwarding of transactions to WebApp endpoint and observe retry behaviour.
- Steps:
  1. Identify a processed transaction that has not been forwarded (or create one and set forwarding=false via DB if needed).
  2. Use Admin action to forward/resend to WebApp (or run the forwarding CLI, as allowed by admin privileges).
  3. Observe Horizon `forwarding` supervisor and job status. Confirm webapp receives payload (or simulated endpoint ack).
- Expected result: Forward job enqueued and processed. Admin sees status update and logs of success/failure.

TC-ADMIN-006 — Admin can see non-VAT transactions in reports and Z-reading reconciliation
- Purpose: Validate reports include non-VAT sales and that timestamp alignment supports reconciliation.
- Steps:
  1. Generate transactions across times (including non-VAT entries).
  2. Generate the Z-reading report for the terminal/tenant in admin UI.
  3. Compare Z-reading totals against database aggregates for gross_sales, net_sales, vat_exempt_sales and VAT.
- Expected result: Totals match or have documented acceptable deltas; non-VAT amounts present in vat_exempt_sales column.

TC-ADMIN-007 — Admin can view system health and queue metrics
- Purpose: Admin should be able to assess system health (worker counts, queue depth, long waits).
- Steps:
  1. Open Admin Dashboard / Command-Center.
  2. Verify worker counts for `transaction-processing`, `forwarding`, `low`, `notifications` match expected `HZ_*_PROCESSES` values.
  3. Observe long-wait alerts if any and verify they include queue name and wait time.
- Expected result: Process counts are visible and match the configured env values. Long-wait metrics populate as expected.

TC-ADMIN-008 — Admin security checks: access control, HTTPS, HSTS
- Purpose: Confirm Horizon and Admin endpoints are secured and only accessible to authorized users.
- Steps:
  1. Attempt to access `/command-center` while logged out — should redirect to login.
  2. Login as a non-admin role (if available) and attempt access — should receive 403 (or be denied).
  3. Verify URL uses HTTPS in staging production; HSTS header present.
- Expected result: Access gates enforced; secure transport present in production. Record headers and status codes.

TC-ADMIN-009 — Admin can observe and act on retry/backoff behaviour during transient failures
- Purpose: Verify retry/backoff (exponential) works for forwarding and transaction-processing jobs and that admin visibility shows retry attempts.
- Steps:
  1. Simulate transient downstream failure (e.g., block WebApp endpoint for a few minutes).
  2. Submit transactions that trigger forwarding.
  3. Observe jobs retries, backoff delays, and eventual success (or escalation to failed state). Check Horizon/log entries.
- Expected result: Jobs retry with increasing delay; admin sees retry attempts and can identify circuit-breaker open events (if implemented).

TC-ADMIN-010 — Admin can export failed-job payloads for audit
- Purpose: Ensure admins can export failed job data to a file or archive for offline audit.
- Steps:
  1. From Horizon UI or admin interface, select failed job(s) and use export action.
  2. Confirm exported file includes submission_uuid, transaction_id, tenant_id, terminal_id, exception, and timestamp.
- Expected result: Export generates a JSON/CSV file downloadable by admin and matches expected columns. Sensitive data redaction policy enforced.

TC-ADMIN-011 — Admin can view transaction logs and troubleshoot transactions
- Purpose: Ensure Admins can access and search application transaction logs and map log entries to transactions for investigation.
- Steps:
  1. Submit a sample transaction (use `scripts/test_4986_payload.php` or the API) and note the `submission_uuid` / `transaction_id`.
  2. In Admin UI or the Logs/Operations section, open the transaction log viewer (if available).
  3. Search logs by `transaction_id`, `submission_uuid`, tenant id, or terminal id.
  4. Verify log entries include timestamps, log level, correlated job id or Horizon job id, and any exception traces for failures.
  5. If UI export is available, export the log slice for the transaction; otherwise, run a server-side query:
     - `grep -R "<transaction_id|submission_uuid>" storage/logs/laravel.log` (or use the centralized logging service query)
  6. Confirm the log shows the ingestion, processing, forwarding attempts, and final status for that transaction.
  7. Verify log redaction rules (no sensitive PII in exported logs) and that access is audit-logged (who exported/visited logs).
- Expected result: Admin can find and export log entries correlated to a transaction. Log entries include job ids, timestamps, and status messages. Exports respect redaction policy and exports/actions are recorded in audit logs.


Sign-off Criteria
-----------------
- All critical test cases (TC-ADMIN-001..TC-ADMIN-007) must PASS.
- Any FAIL must include reproduction steps, logs, and severity assessment (blocker/major/minor).
- Product owner and QA lead must sign the UAT results document.

Post-UAT Actions
----------------
- For any failures, create issues in the backlog with labels `uat-fail` and `urgent` where applicable. Attach logs and job IDs.
- For any operational tuning requests (Horizon sizing, retry_after changes), open infra task and link this UAT evidence.

Appendix: Quick commands and checks for Admin testers
----------------------------------------------------
- Horizon status: `php artisan horizon:status`
- View failed jobs: `php artisan queue:failed` and `php artisan queue:retry <id>`
- Recompute checksums / generate payload: `php scripts/test_4986_payload.php`
- Check Laravel logs: `tail -n 200 storage/logs/laravel.log`

Document history
----------------
- 1.0 — 2025-09-23 — Initial UAT created.
